<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Learning - Chukaman Conversation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Sticky Navigation */
        .nav-header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 1rem;
        }

        .nav-header h1 {
            text-align: center;
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Score Display */
        .score-display {
            text-align: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .score-display strong {
            color: #667eea;
        }

        /* Main Container */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tokenized Transcript Styles */
        .transcript {
            line-height: 3;
            font-size: 1rem;
        }

        .sentence {
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .token {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            padding: 0.25rem;
        }

        .kanji {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .furigana {
            font-size: 0.7rem;
            color: #7f8c8d;
            margin-bottom: 0.2rem;
        }

        .romaji {
            font-size: 0.8rem;
            color: #95a5a6;
            font-style: italic;
        }

        /* Particle Highlighting */
        .particle {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .particle .kanji {
            color: white;
        }

        .particle .furigana,
        .particle .romaji {
            color: #ecf0f1;
        }

        /* Flashcard Styles */
        .flashcard-container {
            perspective: 1000px;
            margin-bottom: 2rem;
        }

        .flashcard {
            width: 100%;
            height: 300px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .flashcard-word {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .flashcard-reading {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .flashcard-meaning {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .flashcard-example {
            font-size: 1rem;
            text-align: center;
            opacity: 0.9;
        }

        .flashcard-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* Quiz Styles */
        .quiz-question {
            margin-bottom: 2rem;
        }

        .quiz-question h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .quiz-option {
            padding: 1rem;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .quiz-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .quiz-option.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .quiz-option.incorrect {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .quiz-feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .quiz-feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .quiz-feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .quiz-score {
            text-align: center;
            font-size: 2rem;
            color: #667eea;
            margin: 2rem 0;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 0 0.5rem;
            }

            .section {
                padding: 1.5rem;
            }

            .kanji {
                font-size: 1.5rem;
            }

            .flashcard-word {
                font-size: 2.5rem;
            }

            .nav-header h1 {
                font-size: 1.2rem;
            }
        }

        .hint {
            text-align: center;
            color: #95a5a6;
            font-size: 0.9rem;
            margin-top: 1rem;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #667eea;
        }

        /* YouTube URL Input Styles */
        .url-input-container {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #667eea;
        }

        .url-input-container h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .url-input-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .url-input {
            flex: 1;
            min-width: 200px;
            padding: 0.8rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .load-btn {
            padding: 0.8rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .load-btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .load-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .transcript-toggle {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .toggle-btn {
            padding: 0.5rem 1rem;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="nav-header">
        <h1>üáØüáµ Japanese Learning - Chukaman</h1>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('transcript')">üìñ Transcript</button>
            <button class="nav-tab" onclick="showSection('flashcards')">üé¥ Flashcards</button>
            <button class="nav-tab" onclick="showSection('quiz')">üìù Quiz</button>
        </div>
        <div class="score-display" id="scoreDisplay">
            <span id="authStatus">üîí Connecting to Firebase...</span>
        </div>
    </nav>

    <div class="container">
        <!-- Transcript Section -->
        <section id="transcript" class="section active">
            <h2 style="color: #667eea; margin-bottom: 1.5rem;">Tokenized Transcript</h2>
            <p style="margin-bottom: 1rem; color: #7f8c8d;">
                Interactive breakdown with Kanji, Furigana (reading), and Romaji (romanization).
                Particles are highlighted in dark mode for grammatical clarity.
            </p>

            <!-- YouTube URL Input -->
            <div class="url-input-container">
                <h3>üé• Load Transcript from YouTube</h3>
                <div class="url-input-group">
                    <input
                        type="text"
                        id="youtubeUrl"
                        class="url-input"
                        placeholder="Paste YouTube URL here (e.g., https://youtu.be/...)">
                    <button class="load-btn" onclick="loadYouTubeTranscript()">
                        Load Transcript
                    </button>
                </div>
                <div class="transcript-toggle">
                    <span style="color: #7f8c8d; margin-right: 0.5rem;">Transcript view:</span>
                    <button class="toggle-btn active" onclick="setTranscriptView('sample')">Sample</button>
                    <button class="toggle-btn" onclick="setTranscriptView('loaded')">Loaded from YouTube</button>
                </div>
                <div id="statusMessage" class="status-message"></div>
            </div>

            <div class="transcript" id="transcriptContent"></div>
        </section>

        <!-- Flashcards Section -->
        <section id="flashcards" class="section">
            <h2 style="color: #667eea; margin-bottom: 1.5rem;">Vocabulary Flashcards</h2>
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-front">
                        <div class="flashcard-word" id="cardWord"></div>
                        <div class="flashcard-reading" id="cardReading"></div>
                        <div class="hint">Click to flip</div>
                    </div>
                    <div class="flashcard-back">
                        <div class="flashcard-meaning" id="cardMeaning"></div>
                        <div class="flashcard-example" id="cardExample"></div>
                        <div class="hint">Click to flip back</div>
                    </div>
                </div>
            </div>
            <div class="flashcard-controls">
                <button class="btn btn-secondary" onclick="previousCard()">‚Üê Previous</button>
                <button class="btn btn-primary" onclick="nextCard()">Next ‚Üí</button>
            </div>
            <p style="text-align: center; margin-top: 1rem; color: #7f8c8d;">
                Card <span id="cardNumber">1</span> of <span id="totalCards">0</span>
            </p>
        </section>

        <!-- Quiz Section -->
        <section id="quiz" class="section">
            <h2 style="color: #667eea; margin-bottom: 1.5rem;">Comprehension Quiz</h2>
            <div id="quizContent"></div>
        </section>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration (Replace with your own Firebase config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase (only if config is provided)
        let db = null;
        let auth = null;
        let currentUser = null;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // Sign in anonymously
                auth.signInAnonymously().then((userCredential) => {
                    currentUser = userCredential.user;
                    updateAuthStatus();
                    loadBestScore();
                }).catch((error) => {
                    console.log("Auth error:", error);
                    document.getElementById('authStatus').textContent = '‚ö†Ô∏è Firebase not configured';
                });
            } else {
                document.getElementById('authStatus').textContent = '‚ö†Ô∏è Firebase not configured (scores won\'t be saved)';
            }
        } catch (error) {
            console.log("Firebase initialization error:", error);
            document.getElementById('authStatus').textContent = '‚ö†Ô∏è Firebase not configured';
        }

        function updateAuthStatus() {
            if (currentUser) {
                document.getElementById('authStatus').innerHTML =
                    `‚úÖ Connected as Guest | Best Score: <strong id="bestScore">Loading...</strong>`;
            }
        }

        async function loadBestScore() {
            if (!db || !currentUser) return;

            try {
                const docRef = db.collection('userScores').doc(currentUser.uid);
                const doc = await docRef.get();

                if (doc.exists) {
                    const bestScore = doc.data().bestScore || 0;
                    document.getElementById('bestScore').textContent = bestScore + '%';
                } else {
                    document.getElementById('bestScore').textContent = '0%';
                }
            } catch (error) {
                console.log("Error loading score:", error);
                document.getElementById('bestScore').textContent = 'N/A';
            }
        }

        async function saveBestScore(score) {
            if (!db || !currentUser) return;

            try {
                const docRef = db.collection('userScores').doc(currentUser.uid);
                const doc = await docRef.get();

                let currentBest = 0;
                if (doc.exists) {
                    currentBest = doc.data().bestScore || 0;
                }

                if (score > currentBest) {
                    await docRef.set({
                        bestScore: score,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    document.getElementById('bestScore').textContent = score + '%';
                }
            } catch (error) {
                console.log("Error saving score:", error);
            }
        }

        // Japanese Transcript Data
        const transcriptData = [
            {
                sentence: [
                    { kanji: "‰∏≠ËèØ„Åæ„Çì", furigana: "„Å°„ÇÖ„ÅÜ„Åã„Åæ„Çì", romaji: "ch≈´kaman", type: "word" },
                    { kanji: "„ÅØ", furigana: "„ÅØ", romaji: "wa", type: "particle" },
                    { kanji: "Êó•Êú¨", furigana: "„Å´„Åª„Çì", romaji: "nihon", type: "word" },
                    { kanji: "„Åß", furigana: "„Åß", romaji: "de", type: "particle" },
                    { kanji: "‰∫∫Ê∞ó", furigana: "„Å´„Çì„Åç", romaji: "ninki", type: "word" },
                    { kanji: "„ÅÆ", furigana: "„ÅÆ", romaji: "no", type: "particle" },
                    { kanji: "ËªΩÈ£ü", furigana: "„Åë„ÅÑ„Åó„Çá„Åè", romaji: "keishoku", type: "word" },
                    { kanji: "„Åß„Åô", furigana: "„Åß„Åô", romaji: "desu", type: "word" }
                ]
            },
            {
                sentence: [
                    { kanji: "„Ç≥„É≥„Éì„Éã", furigana: "„Ç≥„É≥„Éì„Éã", romaji: "konbini", type: "word" },
                    { kanji: "„Åß", furigana: "„Åß", romaji: "de", type: "particle" },
                    { kanji: "„Çà„Åè", furigana: "„Çà„Åè", romaji: "yoku", type: "word" },
                    { kanji: "Â£≤„Å£„Å¶", furigana: "„ÅÜ„Å£„Å¶", romaji: "utte", type: "word" },
                    { kanji: "„ÅÑ„Åæ„Åô", furigana: "„ÅÑ„Åæ„Åô", romaji: "imasu", type: "word" }
                ]
            },
            {
                sentence: [
                    { kanji: "ËÇâ„Åæ„Çì", furigana: "„Å´„Åè„Åæ„Çì", romaji: "nikuman", type: "word" },
                    { kanji: "„Å®", furigana: "„Å®", romaji: "to", type: "particle" },
                    { kanji: "„ÅÇ„Çì„Åæ„Çì", furigana: "„ÅÇ„Çì„Åæ„Çì", romaji: "anman", type: "word" },
                    { kanji: "„Åå", furigana: "„Åå", romaji: "ga", type: "particle" },
                    { kanji: "Áâπ„Å´", furigana: "„Å®„Åè„Å´", romaji: "tokuni", type: "word" },
                    { kanji: "‰∫∫Ê∞ó", furigana: "„Å´„Çì„Åç", romaji: "ninki", type: "word" },
                    { kanji: "„Åß„Åô", furigana: "„Åß„Åô", romaji: "desu", type: "word" }
                ]
            },
            {
                sentence: [
                    { kanji: "ÂÜ¨", furigana: "„Åµ„ÇÜ", romaji: "fuyu", type: "word" },
                    { kanji: "„Å´", furigana: "„Å´", romaji: "ni", type: "particle" },
                    { kanji: "Ê∏©„Åã„ÅÑ", furigana: "„ÅÇ„Åü„Åü„Åã„ÅÑ", romaji: "atatakai", type: "word" },
                    { kanji: "‰∏≠ËèØ„Åæ„Çì", furigana: "„Å°„ÇÖ„ÅÜ„Åã„Åæ„Çì", romaji: "ch≈´kaman", type: "word" },
                    { kanji: "„Çí", furigana: "„Çí", romaji: "wo", type: "particle" },
                    { kanji: "È£ü„Åπ„Çã", furigana: "„Åü„Åπ„Çã", romaji: "taberu", type: "word" },
                    { kanji: "„ÅÆ„ÅØ", furigana: "„ÅÆ„ÅØ", romaji: "no wa", type: "particle" },
                    { kanji: "ÊúÄÈ´ò", furigana: "„Åï„ÅÑ„Åì„ÅÜ", romaji: "saik≈ç", type: "word" },
                    { kanji: "„Åß„Åô", furigana: "„Åß„Åô", romaji: "desu", type: "word" }
                ]
            }
        ];

        // Flashcard Data
        const flashcards = [
            {
                word: "‰∏≠ËèØ„Åæ„Çì",
                reading: "„Å°„ÇÖ„ÅÜ„Åã„Åæ„Çì (ch≈´kaman)",
                meaning: "Chinese-style steamed bun",
                example: "„Ç≥„É≥„Éì„Éã„Åß‰∏≠ËèØ„Åæ„Çì„ÇíË≤∑„ÅÑ„Åæ„Åó„Åü"
            },
            {
                word: "ËÇâ„Åæ„Çì",
                reading: "„Å´„Åè„Åæ„Çì (nikuman)",
                meaning: "Meat-filled steamed bun",
                example: "ËÇâ„Åæ„Çì„Åå‰∏ÄÁï™Â•Ω„Åç„Åß„Åô"
            },
            {
                word: "„ÅÇ„Çì„Åæ„Çì",
                reading: "„ÅÇ„Çì„Åæ„Çì (anman)",
                meaning: "Sweet red bean bun",
                example: "„ÅÇ„Çì„Åæ„Çì„ÅØÁîò„Åè„Å¶ÁæéÂë≥„Åó„ÅÑ"
            },
            {
                word: "„Ç≥„É≥„Éì„Éã",
                reading: "„Åì„Çì„Å≥„Å´ (konbini)",
                meaning: "Convenience store",
                example: "„Ç≥„É≥„Éì„Éã„ÅßË≤∑„ÅÑÁâ©„Çí„Åó„Åæ„Åô"
            },
            {
                word: "‰∫∫Ê∞ó",
                reading: "„Å´„Çì„Åç (ninki)",
                meaning: "Popular, popularity",
                example: "„Åì„ÅÆ„ÅäÂ∫ó„ÅØ‰∫∫Ê∞ó„Åå„ÅÇ„Çä„Åæ„Åô"
            },
            {
                word: "ËªΩÈ£ü",
                reading: "„Åë„ÅÑ„Åó„Çá„Åè (keishoku)",
                meaning: "Light meal, snack",
                example: "ËªΩÈ£ü„ÇíÈ£ü„Åπ„Åæ„Åó„Åü"
            }
        ];

        // Quiz Data
        const quizQuestions = [
            {
                question: "What does ‰∏≠ËèØ„Åæ„Çì (ch≈´kaman) mean?",
                options: [
                    "Chinese-style steamed bun",
                    "Rice ball",
                    "Sandwich",
                    "Noodle soup"
                ],
                correct: 0
            },
            {
                question: "Where are chukaman commonly sold in Japan?",
                options: [
                    "Department stores",
                    "Convenience stores (konbini)",
                    "Movie theaters",
                    "Train stations only"
                ],
                correct: 1
            },
            {
                question: "Which particle is used to mark the direct object in Japanese?",
                options: [
                    "„ÅØ (wa)",
                    "„Åå (ga)",
                    "„Çí (wo)",
                    "„Å´ (ni)"
                ],
                correct: 2
            },
            {
                question: "What are the two most popular types of chukaman mentioned?",
                options: [
                    "Meat and seafood",
                    "Nikuman (meat) and Anman (sweet bean)",
                    "Chicken and vegetable",
                    "Cheese and corn"
                ],
                correct: 1
            },
            {
                question: "When is eating warm chukaman described as 'the best' (ÊúÄÈ´ò)?",
                options: [
                    "In summer",
                    "In spring",
                    "In winter",
                    "In autumn"
                ],
                correct: 2
            }
        ];

        // YouTube Transcript Loading
        let loadedTranscriptData = [];
        let currentTranscriptView = 'sample'; // 'sample' or 'loaded'

        // Firebase Cloud Function Configuration
        // IMPORTANT: Replace this with your actual Firebase Function URL after deployment
        // See FIREBASE_SETUP.md for detailed instructions
        const FIREBASE_FUNCTION_URL = 'YOUR_FIREBASE_FUNCTION_URL_HERE';
        // Example: 'https://us-central1-your-project-id.cloudfunctions.net/getTranscript'

        function extractVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/,
                /youtube\.com\/embed\/([^&\n?#]+)/,
                /youtube\.com\/v\/([^&\n?#]+)/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }

        async function loadYouTubeTranscript() {
            const urlInput = document.getElementById('youtubeUrl');
            const url = urlInput.value.trim();
            const loadBtn = event.target;

            if (!url) {
                showStatus('Please enter a YouTube URL', 'error');
                return;
            }

            const videoId = extractVideoId(url);
            if (!videoId) {
                showStatus('Invalid YouTube URL. Please check and try again.', 'error');
                return;
            }

            // Check if Firebase Function is configured
            if (FIREBASE_FUNCTION_URL === 'YOUR_FIREBASE_FUNCTION_URL_HERE') {
                showStatus(
                    '‚ö†Ô∏è Firebase Function not configured. See FIREBASE_SETUP.md for setup instructions. Using manual paste fallback...',
                    'error'
                );

                console.log('%cüìù FIREBASE SETUP REQUIRED', 'color: #667eea; font-size: 16px; font-weight: bold;');
                console.log('To enable automatic transcript loading, follow the setup guide in FIREBASE_SETUP.md');
                console.log('Repository: https://github.com/Xxwo2/Xxwo2.github.io/blob/main/FIREBASE_SETUP.md');

                // Fallback to manual paste
                const manualText = prompt(
                    'Firebase Function not set up yet.\n\n' +
                    'Would you like to paste the Japanese transcript manually?\n\n' +
                    '(Visit the video, click "..." ‚Üí "Show transcript", and copy the text)'
                );

                if (manualText && manualText.trim()) {
                    parseAndDisplayTranscript(manualText);
                    showStatus('Transcript loaded successfully! Switch to "Loaded from YouTube" view above.', 'success');
                    setTranscriptView('loaded');
                } else {
                    showStatus('Transcript loading cancelled.', 'info');
                }
                return;
            }

            // Use Firebase Cloud Function for automatic fetching
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            showStatus('Fetching transcript from YouTube via Firebase...', 'info');

            try {
                const apiUrl = `${FIREBASE_FUNCTION_URL}?videoId=${videoId}&lang=ja`;
                console.log('Fetching from:', apiUrl);

                const response = await fetch(apiUrl);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to fetch transcript');
                }

                // Extract the full transcript text
                const transcriptText = data.data.fullText;

                console.log('‚úÖ Transcript fetched successfully');
                console.log(`üìä ${data.data.entries.length} entries, ${transcriptText.length} characters`);

                // Parse and display the transcript
                parseAndDisplayTranscript(transcriptText);
                showStatus(
                    `‚úÖ Transcript loaded! (${data.data.entries.length} entries) Switch to "Loaded from YouTube" view above.`,
                    'success'
                );
                setTranscriptView('loaded');

            } catch (error) {
                console.error('‚ùå Error loading transcript:', error);

                let errorMessage = error.message;
                if (errorMessage.includes('Transcript is disabled')) {
                    errorMessage = '‚ùå Transcripts are disabled for this video';
                } else if (errorMessage.includes('No ja transcript')) {
                    errorMessage = '‚ùå No Japanese transcript found. Try a video with Japanese subtitles.';
                } else if (errorMessage.includes('Video unavailable')) {
                    errorMessage = '‚ùå Video is unavailable or does not exist';
                } else if (errorMessage.includes('Failed to fetch')) {
                    errorMessage = '‚ùå Network error. Check your internet connection and Firebase Function URL.';
                }

                showStatus(errorMessage, 'error');

                // Offer manual paste as fallback
                const tryManual = confirm(
                    'Automatic loading failed.\n\n' +
                    'Would you like to paste the transcript manually instead?\n\n' +
                    '(Visit the video, click "..." ‚Üí "Show transcript", and copy the text)'
                );

                if (tryManual) {
                    const manualText = prompt('Paste the Japanese transcript here:');
                    if (manualText && manualText.trim()) {
                        parseAndDisplayTranscript(manualText);
                        showStatus('Transcript loaded successfully! Switch to "Loaded from YouTube" view above.', 'success');
                        setTranscriptView('loaded');
                    }
                }

            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'Load Transcript';
            }
        }

        function parseAndDisplayTranscript(text) {
            // Simple Japanese text parser
            // For production, you'd want to use a library like kuromoji or TinySegmenter
            const lines = text.split(/[„ÄÇÔºÅÔºü\n]+/).filter(s => s.trim());

            loadedTranscriptData = [];

            // Common Japanese particles
            const particles = ['„ÅØ', '„Åå', '„Çí', '„Å´', '„Å∏', '„Å®', '„Åã„Çâ', '„Åæ„Åß', '„Åß', '„ÅÆ', '„ÇÑ', '„Åã', '„ÇÇ', '„Å≠', '„Çà', '„Å™'];

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;

                // Simple word segmentation (for demo - in production use proper tokenizer)
                const tokens = [];
                let currentWord = '';

                for (let i = 0; i < trimmed.length; i++) {
                    const char = trimmed[i];
                    const nextChar = trimmed[i + 1] || '';

                    currentWord += char;

                    // Check if current character(s) form a particle
                    const isParticle = particles.includes(char) || particles.includes(char + nextChar);

                    // Break on particle or sentence end
                    if (isParticle || i === trimmed.length - 1 || this.isWordBreak(char, nextChar)) {
                        if (currentWord.trim()) {
                            tokens.push({
                                kanji: currentWord,
                                furigana: currentWord, // Simplified - needs real furigana library
                                romaji: this.toRomaji(currentWord), // Simplified romanization
                                type: particles.includes(currentWord) ? 'particle' : 'word'
                            });
                            currentWord = '';
                        }
                    }
                }

                if (tokens.length > 0) {
                    loadedTranscriptData.push({ sentence: tokens });
                }
            });

            console.log('Parsed transcript:', loadedTranscriptData);
        }

        function toRomaji(japanese) {
            // Very simplified romaji conversion (for demo only)
            // In production, use wanakana.js or similar
            const kanaMap = {
                '„ÅÇ': 'a', '„ÅÑ': 'i', '„ÅÜ': 'u', '„Åà': 'e', '„Åä': 'o',
                '„Åã': 'ka', '„Åç': 'ki', '„Åè': 'ku', '„Åë': 'ke', '„Åì': 'ko',
                '„Åï': 'sa', '„Åó': 'shi', '„Åô': 'su', '„Åõ': 'se', '„Åù': 'so',
                '„Åü': 'ta', '„Å°': 'chi', '„Å§': 'tsu', '„Å¶': 'te', '„Å®': 'to',
                '„Å™': 'na', '„Å´': 'ni', '„Å¨': 'nu', '„Å≠': 'ne', '„ÅÆ': 'no',
                '„ÅØ': 'ha', '„Å≤': 'hi', '„Åµ': 'fu', '„Å∏': 'he', '„Åª': 'ho',
                '„Åæ': 'ma', '„Åø': 'mi', '„ÇÄ': 'mu', '„ÇÅ': 'me', '„ÇÇ': 'mo',
                '„ÇÑ': 'ya', '„ÇÜ': 'yu', '„Çà': 'yo',
                '„Çâ': 'ra', '„Çä': 'ri', '„Çã': 'ru', '„Çå': 're', '„Çç': 'ro',
                '„Çè': 'wa', '„Çí': 'wo', '„Çì': 'n',
                '„Åå': 'ga', '„Åé': 'gi', '„Åê': 'gu', '„Åí': 'ge', '„Åî': 'go',
                '„Åñ': 'za', '„Åò': 'ji', '„Åö': 'zu', '„Åú': 'ze', '„Åû': 'zo',
                '„Å†': 'da', '„Å¢': 'ji', '„Å•': 'zu', '„Åß': 'de', '„Å©': 'do',
                '„Å∞': 'ba', '„Å≥': 'bi', '„Å∂': 'bu', '„Åπ': 'be', '„Åº': 'bo',
                '„Å±': 'pa', '„Å¥': 'pi', '„Å∑': 'pu', '„Å∫': 'pe', '„ÅΩ': 'po'
            };

            let romaji = '';
            for (const char of japanese) {
                romaji += kanaMap[char] || char;
            }
            return romaji || japanese;
        }

        function setTranscriptView(view) {
            currentTranscriptView = view;

            // Update toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Render appropriate transcript
            const container = document.getElementById('transcriptContent');
            container.innerHTML = '';

            if (view === 'sample') {
                renderTranscript();
            } else if (view === 'loaded') {
                if (loadedTranscriptData.length === 0) {
                    container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 2rem;">No transcript loaded yet. Use the input above to load from YouTube.</p>';
                } else {
                    renderLoadedTranscript();
                }
            }
        }

        function renderLoadedTranscript() {
            const container = document.getElementById('transcriptContent');

            loadedTranscriptData.forEach((line, lineIndex) => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence';

                line.sentence.forEach(token => {
                    const tokenDiv = document.createElement('div');
                    tokenDiv.className = `token ${token.type === 'particle' ? 'particle' : ''}`;

                    tokenDiv.innerHTML = `
                        <div class="furigana">${token.furigana}</div>
                        <div class="kanji">${token.kanji}</div>
                        <div class="romaji">${token.romaji}</div>
                    `;

                    sentenceDiv.appendChild(tokenDiv);
                });

                container.appendChild(sentenceDiv);
            });
        }

        // App State
        let currentCardIndex = 0;
        let currentQuizAnswers = [];
        let quizSubmitted = false;

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            if (sectionId === 'quiz' && !quizSubmitted) {
                initQuiz();
            }
        }

        // Render Transcript
        function renderTranscript() {
            const container = document.getElementById('transcriptContent');

            transcriptData.forEach((line, lineIndex) => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence';

                line.sentence.forEach(token => {
                    const tokenDiv = document.createElement('div');
                    tokenDiv.className = `token ${token.type === 'particle' ? 'particle' : ''}`;

                    tokenDiv.innerHTML = `
                        <div class="furigana">${token.furigana}</div>
                        <div class="kanji">${token.kanji}</div>
                        <div class="romaji">${token.romaji}</div>
                    `;

                    sentenceDiv.appendChild(tokenDiv);
                });

                container.appendChild(sentenceDiv);
            });
        }

        // Flashcard Functions
        function updateCard() {
            const card = flashcards[currentCardIndex];
            document.getElementById('cardWord').textContent = card.word;
            document.getElementById('cardReading').textContent = card.reading;
            document.getElementById('cardMeaning').textContent = card.meaning;
            document.getElementById('cardExample').textContent = card.example;
            document.getElementById('cardNumber').textContent = currentCardIndex + 1;
            document.getElementById('totalCards').textContent = flashcards.length;

            // Reset flip state
            document.getElementById('flashcard').classList.remove('flipped');
        }

        function flipCard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function nextCard() {
            currentCardIndex = (currentCardIndex + 1) % flashcards.length;
            updateCard();
        }

        function previousCard() {
            currentCardIndex = (currentCardIndex - 1 + flashcards.length) % flashcards.length;
            updateCard();
        }

        // Quiz Functions
        function initQuiz() {
            if (quizSubmitted) return;

            currentQuizAnswers = new Array(quizQuestions.length).fill(null);
            const container = document.getElementById('quizContent');
            container.innerHTML = '';

            quizQuestions.forEach((q, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';

                let optionsHtml = '';
                q.options.forEach((option, oIndex) => {
                    optionsHtml += `
                        <div class="quiz-option" onclick="selectAnswer(${qIndex}, ${oIndex})">
                            ${option}
                        </div>
                    `;
                });

                questionDiv.innerHTML = `
                    <h3>Question ${qIndex + 1}</h3>
                    <p style="margin-bottom: 1rem; font-size: 1.1rem;">${q.question}</p>
                    <div class="quiz-options" id="options-${qIndex}">
                        ${optionsHtml}
                    </div>
                    <div class="quiz-feedback" id="feedback-${qIndex}" style="display: none;"></div>
                `;

                container.appendChild(questionDiv);
            });

            const submitBtn = document.createElement('button');
            submitBtn.className = 'btn btn-primary';
            submitBtn.style.width = '100%';
            submitBtn.style.marginTop = '2rem';
            submitBtn.textContent = 'Submit Quiz';
            submitBtn.onclick = submitQuiz;
            container.appendChild(submitBtn);
        }

        function selectAnswer(questionIndex, optionIndex) {
            if (quizSubmitted) return;

            currentQuizAnswers[questionIndex] = optionIndex;

            const optionsContainer = document.getElementById(`options-${questionIndex}`);
            const options = optionsContainer.querySelectorAll('.quiz-option');

            options.forEach((opt, idx) => {
                opt.classList.remove('selected');
                if (idx === optionIndex) {
                    opt.classList.add('selected');
                }
            });
        }

        function submitQuiz() {
            if (currentQuizAnswers.includes(null)) {
                alert('Please answer all questions before submitting!');
                return;
            }

            quizSubmitted = true;
            let correctCount = 0;

            quizQuestions.forEach((q, qIndex) => {
                const optionsContainer = document.getElementById(`options-${qIndex}`);
                const options = optionsContainer.querySelectorAll('.quiz-option');
                const feedback = document.getElementById(`feedback-${qIndex}`);

                const userAnswer = currentQuizAnswers[qIndex];
                const isCorrect = userAnswer === q.correct;

                if (isCorrect) correctCount++;

                options.forEach((opt, oIndex) => {
                    opt.classList.remove('selected');
                    if (oIndex === q.correct) {
                        opt.classList.add('correct');
                    } else if (oIndex === userAnswer) {
                        opt.classList.add('incorrect');
                    }
                    opt.style.pointerEvents = 'none';
                });

                feedback.style.display = 'block';
                feedback.className = `quiz-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
                feedback.textContent = isCorrect ? '‚úÖ Correct!' : `‚ùå Incorrect. The correct answer is: ${q.options[q.correct]}`;
            });

            const score = Math.round((correctCount / quizQuestions.length) * 100);

            const scoreDiv = document.createElement('div');
            scoreDiv.className = 'quiz-score';
            scoreDiv.innerHTML = `
                Your Score: ${correctCount}/${quizQuestions.length} (${score}%)
                <br>
                <button class="btn btn-primary" onclick="retakeQuiz()" style="margin-top: 1rem; font-size: 1rem;">
                    Retake Quiz
                </button>
            `;

            const container = document.getElementById('quizContent');
            container.querySelector('button').remove();
            container.appendChild(scoreDiv);

            // Save to Firebase
            saveBestScore(score);
        }

        function retakeQuiz() {
            quizSubmitted = false;
            currentQuizAnswers = [];
            initQuiz();
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            renderTranscript();
            updateCard();
        });
    </script>
</body>
</html>
